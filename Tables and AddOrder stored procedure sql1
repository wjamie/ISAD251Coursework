SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[Add_Order](@Order_Id int output, @Table_Number as int,  @Product_Name as varchar(30), @Quantity as int) AS


BEGIN

DECLARE @thesmalldatetime smalldatetime;



DECLARE @Order_Time datetime;
SET @Order_Time = GETDATE();

SET @thesmalldatetime = @Order_Time;


 DECLARE @Product_Id AS INT

 SET @Product_Id = (SELECT Product_Id FROM [Products] WHERE Product_Name = @Product_Name)

    BEGIN TRANSACTION
        DECLARE @Error NVARCHAR(Max);
        
        
        BEGIN TRY
        
  

         INSERT INTO dbo.Orders (Table_Number, Order_Time)
            VALUES (@Table_Number, @thesmalldatetime);

             SET @Order_Id = SCOPE_IDENTITY();

         INSERT INTO dbo.Order_Items (Order_Id, Product_Id, Quantity)
            VALUES (@Order_Id, @Product_Id, @Quantity);

            IF @@TRANCOUNT > 0 COMMIT;
        END TRY
        BEGIN CATCH
            SET @Error = 'An error was encountered : Adding an Order could not happen';
            IF @@TRANCOUNT > 0
                ROLLBACK TRANSACTION;
            RAISERROR(@Error, 1, 0);
        END CATCH; 
END;
GO









SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Products](
	[Product_Id] [int] IDENTITY(1,1) NOT NULL,
	[Product_Name] [varchar](30) NULL,
	[Category] [varchar](20) NOT NULL,
	[Price] [decimal](6, 2) NULL,
	[Re_Order_Level] [int] NOT NULL,
	[Stock_Level] [int] NOT NULL,
 CONSTRAINT [pk_Products] PRIMARY KEY CLUSTERED 
(
	[Product_Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO








SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Orders](
	[Order_Id] [int] IDENTITY(1,1) NOT NULL,
	[Table_Number] [int] NOT NULL,
	[Order_Time] [smalldatetime] NOT NULL,
 CONSTRAINT [pk_Orders] PRIMARY KEY CLUSTERED 
(
	[Order_Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO







SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[Order_Items](
	[Order_Id] [int] NOT NULL,
	[Product_Id] [int] NOT NULL,
	[Quantity] [int] NOT NULL,
 CONSTRAINT [pk_Order_Items] PRIMARY KEY CLUSTERED 
(
	[Order_Id] ASC,
	[Product_Id] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TRIGGER [dbo].[ChangeStock] ON [dbo].[Order_Items]
AFTER INSERT
AS
BEGIN
    UPDATE Products
    SET Products.Stock_Level = Products.Stock_Level - inserted.Quantity
    FROM inserted
    WHERE Products.Product_Id = inserted.Product_Id
END;
GO
ALTER TABLE [dbo].[Order_Items] ENABLE TRIGGER [ChangeStock]
GO






















